CREATE OR REPLACE PROCEDURE gather_partition_stats()
LANGUAGE plpgsql
AS $$
DECLARE
    current_stat_date DATE := current_date;
BEGIN
    -- 1. Создание таблицы для хранения статистики, если не существует
    CREATE TABLE IF NOT EXISTS partition_stats_history (
        root_schema TEXT,
        root_table TEXT,
        stat_date DATE,
        total_seq_scan BIGINT,
        total_seq_tup_read BIGINT,
        total_idx_scan BIGINT,
        total_idx_tup_fetch BIGINT,
        total_n_tup_ins BIGINT,
        total_n_tup_upd BIGINT,
        total_n_tup_del BIGINT,
        total_n_tup_hot_upd BIGINT,
        total_n_live_tup BIGINT,
        total_n_dead_tup BIGINT,
        total_n_mod_since_analyze BIGINT,
        PRIMARY KEY (root_schema, root_table, stat_date)
    );
    
    -- 2. Создание таблицы для дельт, если не существует
    CREATE TABLE IF NOT EXISTS partition_stats_delta (
        root_schema TEXT,
        root_table TEXT,
        period_start DATE,
        period_end DATE,
        delta_seq_scan BIGINT,
        delta_seq_tup_read BIGINT,
        delta_idx_scan BIGINT,
        delta_idx_tup_fetch BIGINT,
        delta_n_tup_ins BIGINT,
        delta_n_tup_upd BIGINT,
        delta_n_tup_del BIGINT,
        delta_n_tup_hot_upd BIGINT,
        delta_n_live_tup BIGINT,
        delta_n_dead_tup BIGINT,
        delta_n_mod_since_analyze BIGINT,
        PRIMARY KEY (root_schema, root_table, period_start, period_end)
    );
    
    -- Вставка текущей статистики
    INSERT INTO partition_stats_history
    WITH partition_hierarchy AS (
        SELECT DISTINCT
            schemaname AS root_schema,
            tablename AS root_table,
            partitionschemaname AS partition_schema,
            partitiontablename AS partition_name
        FROM pg_partitions
        WHERE partitiontablename IS NOT NULL
            AND partitiontablename != tablename
    ),
    partition_stats AS (
        SELECT 
            ph.root_schema,
            ph.root_table,
            SUM(COALESCE(stat.seq_scan, 0)) AS total_seq_scan,
            SUM(COALESCE(stat.seq_tup_read, 0)) AS total_seq_tup_read,
            SUM(COALESCE(stat.idx_scan, 0)) AS total_idx_scan,
            SUM(COALESCE(stat.idx_tup_fetch, 0)) AS total_idx_tup_fetch,
            SUM(COALESCE(stat.n_tup_ins, 0)) AS total_n_tup_ins,
            SUM(COALESCE(stat.n_tup_upd, 0)) AS total_n_tup_upd,
            SUM(COALESCE(stat.n_tup_del, 0)) AS total_n_tup_del,
            SUM(COALESCE(stat.n_tup_hot_upd, 0)) AS total_n_tup_hot_upd,
            SUM(COALESCE(stat.n_live_tup, 0)) AS total_n_live_tup,
            SUM(COALESCE(stat.n_dead_tup, 0)) AS total_n_dead_tup,
            SUM(COALESCE(stat.n_mod_since_analyze, 0)) AS total_n_mod_since_analyze
        FROM partition_hierarchy ph
        LEFT JOIN gp_dist_random('pg_stat_user_tables') stat 
            ON stat.schemaname = ph.partition_schema 
            AND stat.relname = ph.partition_name
        GROUP BY ph.root_schema, ph.root_table
    )
    SELECT 
        root_schema,
        root_table,
        current_stat_date,
        total_seq_scan,
        total_seq_tup_read,
        total_idx_scan,
        total_idx_tup_fetch,
        total_n_tup_ins,
        total_n_tup_upd,
        total_n_tup_del,
        total_n_tup_hot_upd,
        total_n_live_tup,
        total_n_dead_tup,
        total_n_mod_since_analyze
    FROM partition_stats
    ON CONFLICT (root_schema, root_table, stat_date) 
    DO UPDATE SET
        total_seq_scan = EXCLUDED.total_seq_scan,
        total_seq_tup_read = EXCLUDED.total_seq_tup_read,
        total_idx_scan = EXCLUDED.total_idx_scan,
        total_idx_tup_fetch = EXCLUDED.total_idx_tup_fetch,
        total_n_tup_ins = EXCLUDED.total_n_tup_ins,
        total_n_tup_upd = EXCLUDED.total_n_tup_upd,
        total_n_tup_del = EXCLUDED.total_n_tup_del,
        total_n_tup_hot_upd = EXCLUDED.total_n_tup_hot_upd,
        total_n_live_tup = EXCLUDED.total_n_live_tup,
        total_n_dead_tup = EXCLUDED.total_n_dead_tup,
        total_n_mod_since_analyze = EXCLUDED.total_n_mod_since_analyze;
    
    -- 3. Вычисление и запись дельт для существующих данных
    INSERT INTO partition_stats_delta
    WITH previous_stats AS (
        SELECT 
            *,
            LAG(stat_date) OVER (PARTITION BY root_schema, root_table ORDER BY stat_date) AS prev_stat_date,
            LAG(total_seq_scan) OVER (PARTITION BY root_schema, root_table ORDER BY stat_date) AS prev_seq_scan,
            LAG(total_seq_tup_read) OVER (PARTITION BY root_schema, root_table ORDER BY stat_date) AS prev_seq_tup_read,
            LAG(total_idx_scan) OVER (PARTITION BY root_schema, root_table ORDER BY stat_date) AS prev_idx_scan,
            LAG(total_idx_tup_fetch) OVER (PARTITION BY root_schema, root_table ORDER BY stat_date) AS prev_idx_tup_fetch,
            LAG(total_n_tup_ins) OVER (PARTITION BY root_schema, root_table ORDER BY stat_date) AS prev_n_tup_ins,
            LAG(total_n_tup_upd) OVER (PARTITION BY root_schema, root_table ORDER BY stat_date) AS prev_n_tup_upd,
            LAG(total_n_tup_del) OVER (PARTITION BY root_schema, root_table ORDER BY stat_date) AS prev_n_tup_del,
            LAG(total_n_tup_hot_upd) OVER (PARTITION BY root_schema, root_table ORDER BY stat_date) AS prev_n_tup_hot_upd,
            LAG(total_n_live_tup) OVER (PARTITION BY root_schema, root_table ORDER BY stat_date) AS prev_n_live_tup,
            LAG(total_n_dead_tup) OVER (PARTITION BY root_schema, root_table ORDER BY stat_date) AS prev_n_dead_tup,
            LAG(total_n_mod_since_analyze) OVER (PARTITION BY root_schema, root_table ORDER BY stat_date) AS prev_n_mod_since_analyze
        FROM partition_stats_history
    )
    SELECT 
        root_schema,
        root_table,
        prev_stat_date AS period_start,
        stat_date AS period_end,
        total_seq_scan - prev_seq_scan AS delta_seq_scan,
        total_seq_tup_read - prev_seq_tup_read AS delta_seq_tup_read,
        total_idx_scan - prev_idx_scan AS delta_idx_scan,
        total_idx_tup_fetch - prev_idx_tup_fetch AS delta_idx_tup_fetch,
        total_n_tup_ins - prev_n_tup_ins AS delta_n_tup_ins,
        total_n_tup_upd - prev_n_tup_upd AS delta_n_tup_upd,
        total_n_tup_del - prev_n_tup_del AS delta_n_tup_del,
        total_n_tup_hot_upd - prev_n_tup_hot_upd AS delta_n_tup_hot_upd,
        total_n_live_tup - prev_n_live_tup AS delta_n_live_tup,
        total_n_dead_tup - prev_n_dead_tup AS delta_n_dead_tup,
        total_n_mod_since_analyze - prev_n_mod_since_analyze AS delta_n_mod_since_analyze
    FROM previous_stats
    WHERE prev_stat_date IS NOT NULL
        AND NOT EXISTS (
            SELECT 1 FROM partition_stats_delta d 
            WHERE d.root_schema = previous_stats.root_schema 
                AND d.root_table = previous_stats.root_table 
                AND d.period_start = previous_stats.prev_stat_date 
                AND d.period_end = previous_stats.stat_date
        )
    ON CONFLICT (root_schema, root_table, period_start, period_end) 
    DO UPDATE SET
        delta_seq_scan = EXCLUDED.delta_seq_scan,
        delta_seq_tup_read = EXCLUDED.delta_seq_tup_read,
        delta_idx_scan = EXCLUDED.delta_idx_scan,
        delta_idx_tup_fetch = EXCLUDED.delta_idx_tup_fetch,
        delta_n_tup_ins = EXCLUDED.delta_n_tup_ins,
        delta_n_tup_upd = EXCLUDED.delta_n_tup_upd,
        delta_n_tup_del = EXCLUDED.delta_n_tup_del,
        delta_n_tup_hot_upd = EXCLUDED.delta_n_tup_hot_upd,
        delta_n_live_tup = EXCLUDED.delta_n_live_tup,
        delta_n_dead_tup = EXCLUDED.delta_n_dead_tup,
        delta_n_mod_since_analyze = EXCLUDED.delta_n_mod_since_analyze;
END;
$$;
