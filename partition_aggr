-- Часть 1: Получение списка партиций и их родительских таблиц
WITH partition_hierarchy AS (
    -- Используем pg_partitions для получения иерархии партиций
    SELECT DISTINCT
        schemaname AS root_schema,
        tablename AS root_table,
        partitionschemaname AS partition_schema,
        partitiontablename AS partition_name
    FROM pg_partitions
    WHERE partitiontablename IS NOT NULL
        AND partitiontablename != tablename
),
-- Часть 2: Сбор и агрегация статистики по всем сегментам
partition_stats AS (
    SELECT 
        ph.root_schema,
        ph.root_table,
        -- Суммируем статистику по всем партициям и всем сегментам
        SUM(COALESCE(stat.seq_scan, 0)) AS total_seq_scan,
        SUM(COALESCE(stat.seq_tup_read, 0)) AS total_seq_tup_read,
        SUM(COALESCE(stat.idx_scan, 0)) AS total_idx_scan,
        SUM(COALESCE(stat.idx_tup_fetch, 0)) AS total_idx_tup_fetch,
        SUM(COALESCE(stat.n_tup_ins, 0)) AS total_n_tup_ins,
        SUM(COALESCE(stat.n_tup_upd, 0)) AS total_n_tup_upd,
        SUM(COALESCE(stat.n_tup_del, 0)) AS total_n_tup_del,
        SUM(COALESCE(stat.n_tup_hot_upd, 0)) AS total_n_tup_hot_upd,
        SUM(COALESCE(stat.n_live_tup, 0)) AS total_n_live_tup,
        SUM(COALESCE(stat.n_dead_tup, 0)) AS total_n_dead_tup,
        SUM(COALESCE(stat.n_mod_since_analyze, 0)) AS total_n_mod_since_analyze
    FROM partition_hierarchy ph
    -- Используем gp_dist_random для сбора статистики со всех сегментов
    LEFT JOIN gp_dist_random('pg_stat_user_tables') stat 
        ON stat.schemaname = ph.partition_schema 
        AND stat.relname = ph.partition_name
    GROUP BY ph.root_schema, ph.root_table
)
-- Часть 3: Выводим результаты
SELECT 
    root_schema,
    root_table,
    -- Выводим агрегированную статистику
    total_seq_scan,
    total_seq_tup_read,
    total_idx_scan,
    total_idx_tup_fetch,
    total_n_tup_ins,
    total_n_tup_upd,
    total_n_tup_del,
    total_n_tup_hot_upd,
    total_n_live_tup,
    total_n_dead_tup,
    total_n_mod_since_analyze
FROM partition_stats ps
ORDER BY root_schema, root_table;
