-- 1. Создание таблиц
CREATE TABLE IF NOT EXISTS partition_stats_history (
    root_schema TEXT,
    root_table TEXT,
    total_seq_scan BIGINT,
    total_seq_tup_read BIGINT,
    total_idx_scan BIGINT,
    total_idx_tup_fetch BIGINT,
    total_n_tup_ins BIGINT,
    total_n_tup_upd BIGINT,
    total_n_tup_del BIGINT,
    total_n_tup_hot_upd BIGINT,
    total_n_live_tup BIGINT,
    total_n_dead_tup BIGINT,
    total_n_mod_since_analyze BIGINT,
    stats_date DATE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (root_schema, root_table, stats_date)
);

CREATE TABLE IF NOT EXISTS partition_stats_delta (
    root_schema TEXT,
    root_table TEXT,
    delta_seq_scan BIGINT,
    delta_seq_tup_read BIGINT,
    delta_idx_scan BIGINT,
    delta_idx_tup_fetch BIGINT,
    delta_n_tup_ins BIGINT,
    delta_n_tup_upd BIGINT,
    delta_n_tup_del BIGINT,
    delta_n_tup_hot_upd BIGINT,
    delta_n_live_tup BIGINT,
    delta_n_dead_tup BIGINT,
    delta_n_mod_since_analyze BIGINT,
    period_start DATE NOT NULL,
    period_end DATE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (root_schema, root_table, period_start, period_end)
);

-- 2. Основная функция
CREATE OR REPLACE FUNCTION gather_partition_stats()
RETURNS void AS $$
DECLARE
    current_stats_date DATE := CURRENT_DATE;
    prev_stats RECORD;
BEGIN
    -- Вставка текущей статистики
    WITH partition_hierarchy AS (
        SELECT DISTINCT
            schemaname AS root_schema,
            tablename AS root_table,
            partitionschemaname AS partition_schema,
            partitiontablename AS partition_name
        FROM pg_partitions
        WHERE partitiontablename IS NOT NULL
            AND partitiontablename != tablename
    ),
    partition_stats AS (
        SELECT 
            ph.root_schema,
            ph.root_table,
            SUM(COALESCE(stat.seq_scan, 0)) AS total_seq_scan,
            SUM(COALESCE(stat.seq_tup_read, 0)) AS total_seq_tup_read,
            SUM(COALESCE(stat.idx_scan, 0)) AS total_idx_scan,
            SUM(COALESCE(stat.idx_tup_fetch, 0)) AS total_idx_tup_fetch,
            SUM(COALESCE(stat.n_tup_ins, 0)) AS total_n_tup_ins,
            SUM(COALESCE(stat.n_tup_upd, 0)) AS total_n_tup_upd,
            SUM(COALESCE(stat.n_tup_del, 0)) AS total_n_tup_del,
            SUM(COALESCE(stat.n_tup_hot_upd, 0)) AS total_n_tup_hot_upd,
            SUM(COALESCE(stat.n_live_tup, 0)) AS total_n_live_tup,
            SUM(COALESCE(stat.n_dead_tup, 0)) AS total_n_dead_tup,
            SUM(COALESCE(stat.n_mod_since_analyze, 0)) AS total_n_mod_since_analyze
        FROM partition_hierarchy ph
        LEFT JOIN gp_dist_random('pg_stat_user_tables') stat 
            ON stat.schemaname = ph.partition_schema 
            AND stat.relname = ph.partition_name
        GROUP BY ph.root_schema, ph.root_table
    )
    INSERT INTO partition_stats_history (
        root_schema, root_table,
        total_seq_scan, total_seq_tup_read,
        total_idx_scan, total_idx_tup_fetch,
        total_n_tup_ins, total_n_tup_upd,
        total_n_tup_del, total_n_tup_hot_upd,
        total_n_live_tup, total_n_dead_tup,
        total_n_mod_since_analyze,
        stats_date
    )
    SELECT 
        root_schema,
        root_table,
        total_seq_scan,
        total_seq_tup_read,
        total_idx_scan,
        total_idx_tup_fetch,
        total_n_tup_ins,
        total_n_tup_upd,
        total_n_tup_del,
        total_n_tup_hot_upd,
        total_n_live_tup,
        total_n_dead_tup,
        total_n_mod_since_analyze,
        current_stats_date
    FROM partition_stats
    ON CONFLICT (root_schema, root_table, stats_date) 
    DO UPDATE SET
        total_seq_scan = EXCLUDED.total_seq_scan,
        total_seq_tup_read = EXCLUDED.total_seq_tup_read,
        total_idx_scan = EXCLUDED.total_idx_scan,
        total_idx_tup_fetch = EXCLUDED.total_idx_tup_fetch,
        total_n_tup_ins = EXCLUDED.total_n_tup_ins,
        total_n_tup_upd = EXCLUDED.total_n_tup_upd,
        total_n_tup_del = EXCLUDED.total_n_tup_del,
        total_n_tup_hot_upd = EXCLUDED.total_n_tup_hot_upd,
        total_n_live_tup = EXCLUDED.total_n_live_tup,
        total_n_dead_tup = EXCLUDED.total_n_dead_tup,
        total_n_mod_since_analyze = EXCLUDED.total_n_mod_since_analyze,
        created_at = CURRENT_TIMESTAMP;

    -- Вычисление дельт
    FOR prev_stats IN 
        SELECT 
            cur.root_schema,
            cur.root_table,
            cur.stats_date as current_date,
            prev.stats_date as previous_date,
            cur.total_seq_scan - COALESCE(prev.total_seq_scan, 0) as delta_seq_scan,
            cur.total_seq_tup_read - COALESCE(prev.total_seq_tup_read, 0) as delta_seq_tup_read,
            cur.total_idx_scan - COALESCE(prev.total_idx_scan, 0) as delta_idx_scan,
            cur.total_idx_tup_fetch - COALESCE(prev.total_idx_tup_fetch, 0) as delta_idx_tup_fetch,
            cur.total_n_tup_ins - COALESCE(prev.total_n_tup_ins, 0) as delta_n_tup_ins,
            cur.total_n_tup_upd - COALESCE(prev.total_n_tup_upd, 0) as delta_n_tup_upd,
            cur.total_n_tup_del - COALESCE(prev.total_n_tup_del, 0) as delta_n_tup_del,
            cur.total_n_tup_hot_upd - COALESCE(prev.total_n_tup_hot_upd, 0) as delta_n_tup_hot_upd,
            cur.total_n_live_tup - COALESCE(prev.total_n_live_tup, 0) as delta_n_live_tup,
            cur.total_n_dead_tup - COALESCE(prev.total_n_dead_tup, 0) as delta_n_dead_tup,
            cur.total_n_mod_since_analyze - COALESCE(prev.total_n_mod_since_analyze, 0) as delta_n_mod_since_analyze
        FROM partition_stats_history cur
        LEFT JOIN partition_stats_history prev 
            ON cur.root_schema = prev.root_schema 
            AND cur.root_table = prev.root_table
            AND prev.stats_date = (
                SELECT MAX(stats_date) 
                FROM partition_stats_history 
                WHERE root_schema = cur.root_schema 
                    AND root_table = cur.root_table 
                    AND stats_date < cur.stats_date
            )
        WHERE cur.stats_date = current_stats_date
          AND prev.stats_date IS NOT NULL
    LOOP
        INSERT INTO partition_stats_delta (
            root_schema, root_table,
            delta_seq_scan, delta_seq_tup_read,
            delta_idx_scan, delta_idx_tup_fetch,
            delta_n_tup_ins, delta_n_tup_upd,
            delta_n_tup_del, delta_n_tup_hot_upd,
            delta_n_live_tup, delta_n_dead_tup,
            delta_n_mod_since_analyze,
            period_start, period_end
        ) VALUES (
            prev_stats.root_schema,
            prev_stats.root_table,
            prev_stats.delta_seq_scan,
            prev_stats.delta_seq_tup_read,
            prev_stats.delta_idx_scan,
            prev_stats.delta_idx_tup_fetch,
            prev_stats.delta_n_tup_ins,
            prev_stats.delta_n_tup_upd,
            prev_stats.delta_n_tup_del,
            prev_stats.delta_n_tup_hot_upd,
            prev_stats.delta_n_live_tup,
            prev_stats.delta_n_dead_tup,
            prev_stats.delta_n_mod_since_analyze,
            prev_stats.previous_date,
            prev_stats.current_date
        ) ON CONFLICT (root_schema, root_table, period_start, period_end) 
        DO UPDATE SET
            delta_seq_scan = EXCLUDED.delta_seq_scan,
            delta_seq_tup_read = EXCLUDED.delta_seq_tup_read,
            delta_idx_scan = EXCLUDED.delta_idx_scan,
            delta_idx_tup_fetch = EXCLUDED.delta_idx_tup_fetch,
            delta_n_tup_ins = EXCLUDED.delta_n_tup_ins,
            delta_n_tup_upd = EXCLUDED.delta_n_tup_upd,
            delta_n_tup_del = EXCLUDED.delta_n_tup_del,
            delta_n_tup_hot_upd = EXCLUDED.delta_n_tup_hot_upd,
            delta_n_live_tup = EXCLUDED.delta_n_live_tup,
            delta_n_dead_tup = EXCLUDED.delta_n_dead_tup,
            delta_n_mod_since_analyze = EXCLUDED.delta_n_mod_since_analyze,
            created_at = CURRENT_TIMESTAMP;
    END LOOP;
END;
$$ LANGUAGE plpgsql;
